<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Green Week | Gallery</title>
  <style>
    body{font-family:'SF Mono',Monaco,'Cascadia Code','Roboto Mono',Consolas,'Courier New',monospace;background:#0a0a0a;color:#e0e0e0;margin:0}
    .container{max-width:1400px;margin:0 auto;padding:20px}
    a{color:#4dabf7;text-decoration:none} a:hover{text-decoration:underline}
    header{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #333;padding-bottom:16px;margin-bottom:24px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
    .card{background:#111;border:1px solid #222;padding:16px}
    .title{font-weight:bold;color:#fff;margin-bottom:8px}
    .badge{display:inline-block;padding:2px 8px;font-size:12px;border-radius:3px;font-weight:bold}
    .green{background:#00ff00;color:#000}.pending{background:#ffaa00;color:#000}.failed{background:#ff4444;color:#fff}
    .meta{color:#888;font-size:12px;margin-top:8px}
    .nav{display:flex;gap:12px}
    .btn{padding:8px 12px;background:transparent;color:#00ff00;border:1px solid #00ff00;font-size:.9rem}
    .btn:hover{background:#00ff00;color:#000}
    .btn-cta{background:#00ff00;color:#000;border:1px solid #00ff00;font-weight:700}
    .btn-cta:hover{background:#00e600;border-color:#00e600;color:#000}
    .fab{position:fixed;right:24px;bottom:24px;z-index:9999}
    .pulse{animation:pulse 2s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(0,255,0,.6)}70%{box-shadow:0 0 0 12px rgba(0,255,0,0)}100%{box-shadow:0 0 0 0 rgba(0,255,0,0)}}
    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111;color:#00ff00;border:1px solid #00ff00;padding:8px 12px;z-index:10000;opacity:0;transition:opacity .2s}
    .toast.show{opacity:1}
  </style>
</head>
<body data-issue-repo="alwaysgreenhq/alwaysgreen" data-submit="https://github.com/alwaysgreenhq/alwaysgreen/issues/new?labels=rescue-request&title=Rescue+request" data-share-url="">
  <div class="container">
    <header>
      <div>
        <div class="title">Green Week – Gallery</div>
        <div class="meta">All rescued PRs</div>
      </div>
      <div class="nav">
        <a class="btn" href="../">Counter</a>
        <a class="btn" href="../stats.json" rel="noopener noreferrer">Stats JSON</a>
        <a class="btn" href="./truth/">Truth Page</a>
        <a id="submitTop" class="btn btn-cta" target="_blank" rel="noopener noreferrer">Submit PR</a>
        <button id="shareBtn" class="btn" type="button" aria-label="Share this page">Share</button>
      </div>
    </header>
    <div id="grid" class="grid"></div>
  </div>
  <a id="submitFab" class="btn btn-cta fab pulse" target="_blank" rel="noopener noreferrer">Submit PR</a>
  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true" hidden>Link copied</div>

  <script>
    const grid = document.getElementById('grid');
    // --- base path detector (supports / and /<repo>/)
    const _parts = location.pathname.split('/').filter(Boolean);
    const BASE = (_parts.length && _parts[0] !== 'gallery') ? `/${_parts[0]}/` : '/';
    const badge = (s)=> s==='GREEN' ? 'green' : (s==='FAILED' ? 'failed' : 'pending');

    function issueRepoFromContext(){
      const explicit = document.body.dataset.issueRepo;
      return explicit || '';
    }

    async function fetchWithFallback(relativePath){
      const bust = (u) => u + (u.includes('?') ? '&' : '?') + 't=' + Date.now();
      const tryJson = async (u) => { try{ const r = await fetch(bust(u), {cache:'no-store'}); if(r.ok) return r.json(); }catch(_){} return null; };
      let data = await tryJson(relativePath.startsWith('http') ? relativePath : (BASE + relativePath.replace(/^\.\/?/, '')));
      if (data) return data;
      const repo = issueRepoFromContext();
      if (repo){
        const clean = relativePath.replace(/^(\.\/|\.\.\/)+/g, '');
        data = await tryJson(`https://raw.githubusercontent.com/${repo}/main/docs/${clean}`);
        if (data) return data;
      }
      throw new Error('Unable to load ' + relativePath);
    }

    async function load(){
      grid.innerHTML = "<div class='meta'>Loading…</div>";
      try{
        // Fix navs for base path
        const toCounter = document.querySelector('.nav a[href="../"]');
        if (toCounter) toCounter.href = BASE;
        const toStats = document.querySelector('.nav a[href="../stats.json"]');
        if (toStats) toStats.href = `${BASE}stats.json`;

        const items = await fetchWithFallback('prs.json');
        if(!Array.isArray(items) || items.length===0){
          grid.innerHTML = "<div class='meta'>No rescues yet.</div>";
          return;
        }
        items.sort((a,b)=> (b.fixed_at||'').localeCompare(a.fixed_at||''));
        grid.innerHTML = '';
        for(const pr of items){
          const owner = pr.owner || '';
          const repo  = pr.repo  || '';
          const card = document.createElement('div');
          card.className = 'card';
          const ttg = (pr.ttg_hours ?? pr.ttg ?? null);
          card.innerHTML = `
            <div class=\"title\">${owner}/${repo} <span class=\"meta\">#${pr.pr_number}</span></div>
            <div><span class=\"badge ${badge(pr.status)}\">${pr.status||'PENDING'}</span> ${pr.merged?'<span class=\"meta\">MERGED</span>':''}</div>
            <div class=\"meta\">LOC ${Number(pr.loc??0)} • Files ${Number(pr.files??0)} • TTG ${ttg!==null?Number(ttg)+'h':'—'}</div>
            <div class=\"meta\">Fixed: ${pr.fixed_at? new Date(pr.fixed_at).toLocaleString() : '—'}</div>
            <div style=\"margin-top:8px;\">
              <a href=\"https://github.com/${owner}/${repo}/pull/${pr.pr_number}\" target=\"_blank\" rel=\"noopener noreferrer\">Original</a>
              ${pr.fix_pr_number ? ' | <a href=\"https://github.com/'+owner+'/'+repo+'/pull/'+pr.fix_pr_number+'\" target=\"_blank\" rel=\"noopener noreferrer\">Fix</a>' : ''}
            </div>`;
          grid.appendChild(card);
        }
      }catch(e){
        console.error(e);
        grid.innerHTML = "<div class='meta'>Could not load gallery.</div>";
      }
    }

    function showToast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg; t.hidden = false; t.classList.add('show');
      setTimeout(()=>{t.classList.remove('show'); t.hidden = true;}, 1500);
    }

    async function share(){
      const canonical = document.body.dataset.shareUrl || (location.protocol.startsWith('http') ? location.href : '');
      const text = 'Green Week — Gallery';
      if (navigator.share){
        try { await navigator.share({ title: 'Green Week — Gallery', text, url: canonical || undefined }); return; } catch(_) {}
      }
      try { await navigator.clipboard.writeText(canonical || text); showToast('Link copied'); return; } catch(_) {}
      const ta = document.createElement('textarea'); ta.value = canonical || text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); showToast('Link copied');
    }

    (function initSubmitAndShare(){
      const submitUrl = document.body.dataset.submit || `https://github.com/${issueRepoFromContext()}/issues/new`;
      const top = document.getElementById('submitTop');
      const fab = document.getElementById('submitFab');
      if (top) top.href = submitUrl;
      if (fab) fab.href = submitUrl;
      const shareBtn = document.getElementById('shareBtn');
      if (shareBtn) shareBtn.addEventListener('click', share);
    })();

    load();
  </script>
</body>
</html>
