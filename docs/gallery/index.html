<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Green Week | Gallery</title>
  <style>
    body{font-family:'SF Mono',Monaco,'Cascadia Code','Roboto Mono',Consolas,'Courier New',monospace;background:#0a0a0a;color:#e0e0e0;margin:0}
    .container{max-width:1400px;margin:0 auto;padding:20px}
    a{color:#4dabf7;text-decoration:none} a:hover{text-decoration:underline}
    header{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #333;padding-bottom:16px;margin-bottom:24px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
    .card{background:#111;border:1px solid #222;padding:16px}
    .title{font-weight:bold;color:#fff;margin-bottom:8px}
    .badge{display:inline-block;padding:2px 8px;font-size:12px;border-radius:3px;font-weight:bold}
    .green{background:#00ff00;color:#000}.pending{background:#ffaa00;color:#000}.failed{background:#ff4444;color:#fff}
    .meta{color:#888;font-size:12px;margin-top:8px}
    .nav{display:flex;gap:12px}
    .btn{padding:8px 12px;background:transparent;color:#00ff00;border:1px solid #00ff00;font-size:.9rem}
    .btn:hover{background:#00ff00;color:#000}
  </style>
</head>
<body data-issue-repo="greenweek-ai/greenweek-site">
  <div class="container">
    <header>
      <div>
        <div class="title">Green Week – Gallery</div>
        <div class="meta">All rescued PRs</div>
      </div>
      <div class="nav">
        <a class="btn" href="../">Counter</a>
        <a class="btn" href="../stats.json" rel="noopener noreferrer">Stats JSON</a>
        <a class="btn" href="./truth/">Truth Page</a>
      </div>
    </header>
    <div id="grid" class="grid"></div>
  </div>

  <script>
    const grid = document.getElementById('grid');
    const badge = (s)=> s==='GREEN' ? 'green' : (s==='FAILED' ? 'failed' : 'pending');

    function issueRepoFromContext(){
      const explicit = document.body.dataset.issueRepo;
      return explicit || '';
    }

    async function fetchWithFallback(relativePath){
      // Try local relative first
      try{
        const res = await fetch(relativePath + '?t=' + Date.now(), {cache:'no-store'});
        if(res.ok) return res.json();
      }catch(e){ /* fall through */ }
      // file:// fallback to raw GitHub if repo known
      const repo = issueRepoFromContext();
      if(location.protocol === 'file:' && repo){
        const clean = relativePath.replace(/^(\.\/)+/, '').replace(/^(\.\.\/)+/, '');
        const raw = `https://raw.githubusercontent.com/${repo}/main/docs/${clean}?t=` + Date.now();
        const res2 = await fetch(raw, {cache:'no-store'});
        if(res2.ok) return res2.json();
      }
      throw new Error('Unable to load ' + relativePath);
    }

    async function load(){
      grid.innerHTML = "<div class='meta'>Loading…</div>";
      try{
        const items = await fetchWithFallback('../prs.json');
        if(!Array.isArray(items) || items.length===0){
          grid.innerHTML = "<div class='meta'>No rescues yet.</div>";
          return;
        }
        items.sort((a,b)=> (b.fixed_at||'').localeCompare(a.fixed_at||''));
        grid.innerHTML = '';
        for(const pr of items){
          const owner = pr.owner || '';
          const repo  = pr.repo  || '';
          const card = document.createElement('div');
          card.className = 'card';
          const ttg = (pr.ttg_hours ?? pr.ttg ?? null);
          card.innerHTML = `
            <div class=\"title\">${owner}/${repo} <span class=\"meta\">#${pr.pr_number}</span></div>
            <div><span class=\"badge ${badge(pr.status)}\">${pr.status||'PENDING'}</span> ${pr.merged?'<span class=\"meta\">MERGED</span>':''}</div>
            <div class=\"meta\">LOC ${Number(pr.loc??0)} • Files ${Number(pr.files??0)} • TTG ${ttg!==null?Number(ttg)+'h':'—'}</div>
            <div class=\"meta\">Fixed: ${pr.fixed_at? new Date(pr.fixed_at).toLocaleString() : '—'}</div>
            <div style=\"margin-top:8px;\">
              <a href=\"https://github.com/${owner}/${repo}/pull/${pr.pr_number}\" target=\"_blank\" rel=\"noopener noreferrer\">Original</a>
              ${pr.fix_pr_number ? ' | <a href=\"https://github.com/'+owner+'/'+repo+'/pull/'+pr.fix_pr_number+'\" target=\"_blank\" rel=\"noopener noreferrer\">Fix</a>' : ''}
            </div>`;
          grid.appendChild(card);
        }
      }catch(e){
        console.error(e);
        grid.innerHTML = "<div class='meta'>Could not load gallery.</div>";
      }
    }
    load();
  </script>
</body>
</html>
